# winStartup.py
# author: Diego Magdaleno
# Program that installs a python script to run at startup on a
# windows machine. Assumes 1 path for Python PATH variable. Does not
# check if code will run successfully. Only serves as a planting
# device.
# Python 3.6
# Windows 10


import os
import sys
import platform


def main():
	# Check command line args. Must have two in order to proceed.
	if len(sys.argv) != 2:
		print("Usage: python winStartup.py <py program>")
		exit(1)

	# Check host os. Must be Windows in order to proceed.
	if platform.system() != "Windows":
		print("Error: Program must be run on a Windows system.")
		exit(1)

	# Get file path for the startup folder.
	directoriesRaw = os.listdir("C:\\Users\\")
	#print(directoriesRaw)

	# Clean out unwanted directories.
	badNames = [".", "..", "Public", "desktop.ini"]
	for name in badNames:
		if name in directoriesRaw:
			directoriesRaw.remove(name)

	#print(directoriesRaw)
	#directoriesRaw = ["Max"]

	# Iterate through all users. Get the path to their startup folder.
	pathPre = "C:\\Users\\"
	pathSuff1 = "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\"
	pathSuff2 = "Programs\\Startup"
	# Make sure such a path exists. Refine the list as needed.
	listOfPaths = []
	for user in directoriesRaw:
		fullpath = pathPre+user+pathSuff1+pathSuff2
		# Remove items who's full path is either not a directory or
		# does not exist.
		if not os.path.exists(fullpath) or not os.path.isdir(fullpath):
			directoriesRaw.remove(user)
		# Append full paths that do qualify.
		else:
			listOfPaths.append(fullpath)

	# listOfPaths and directoriesRaw should be the same size.
	#print(directoriesRaw)
	#print(listOfPaths)

	# Plant script in every user.
	for path in listOfPaths:
		# Extract name of py program.
		progName = extractProgName()
		#print(progName)
		# Create cmd file.
		scriptName = path + "\\" + "run_"+progName+".cmd"
		try:
			script = open(scriptName, "w")
			# script.write("python path\to\py_program.py")
			# Note: path\to\py_program.py is essentially sys.argv[1].
			script.write("python "+sys.argv[1])
			script.close()
		except PermissionError:
			print("Error: Could not plant file in file path:")
			print(path+"\n")

	# Script planted. Exit program.
	exit(0)


# Extract the py program name from the file path given by the user for
# sys.argv[1].
# @param, takes no arguments.
# @return, returns a string of the program's name.
def extractProgName():
	progPath = sys.argv[1]
	noFrontSlash = progPath.split("\\")
	noBackSlash = noFrontSlash[len(noFrontSlash)-1].split("/")
	return noBackSlash[len(noBackSlash)-1].replace(".", "_")


if __name__ == '__main__':
	main()
